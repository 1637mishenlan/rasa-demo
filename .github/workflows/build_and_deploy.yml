  
name: Build and Deploy
on: [push]

jobs:
  # lint-testing:
  #   name: Code Formatting Tests
  #   runs-on: ubuntu-latest
  #   steps:
  #   - uses: actions/checkout@v1
  #   - name: Set up Python 3.7
  #     uses: actions/setup-python@v1
  #     with:
  #       python-version: 3.7
  #   - name: Install dependencies
  #     run: |
  #       python -m pip install --upgrade pip
  #       pip install -r requirements-dev.txt
  #   - name: Code Formatting Tests
  #     working-directory: ${{ github.workspace }}
  #     run: |
  #       make lint
  # type-testing:
  #   name: Type Tests
  #   runs-on: ubuntu-latest
  #   steps:
  #   - uses: actions/checkout@v1
  #   - name: Set up Python 3.7
  #     uses: actions/setup-python@v1
  #     with:
  #       python-version: 3.7
  #   - name: Install dependencies
  #     run: |
  #       python -m pip install --upgrade pip
  #       pip install -r requirements-dev.txt
  #   - name: Type Checking
  #     working-directory: ${{ github.workspace }}
  #     run: |
  #       make types
  # training-testing:
  #   name: Testing Stories
  #   runs-on: ubuntu-latest
  #   steps:
  #   - uses: actions/checkout@v1
  #   - name: Set up Python 3.7
  #     uses: actions/setup-python@v1
  #     with:
  #       python-version: 3.7
  #   - name: Install dependencies
  #     run: |
  #       python -m pip install --upgrade pip
  #       pip install -r requirements-dev.txt
  #   - name: Train Model
  #     working-directory: ${{ github.workspace }}
  #     run: |
  #       rasa train
  #   - name: Test Training Stories
  #     working-directory: ${{ github.workspace }}
  #     run: |
  #       rasa test --stories test_stories/stories.md --fail-on-prediction-errors
  #   - name: Cross-validate NLU model
  #     run: |
  #       rasa test nlu -f 5 --cross-validation
  #       python format_results.py 
  build-images:
    name: Build and Push Images
    runs-on: ubuntu-latest
    # needs: [lint-testing, type-testing]
    steps:
    - uses: actions/checkout@v1
    - name: Set up Python 3.7
      uses: actions/setup-python@v1
      with:
        python-version: 3.7
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-dev.txt
    - name: Login to gcloud registry
      id: gcloud
      uses: elgohr/gcloud-login-action@master
      with:
        account_key: ${{ secrets.GCLOUD_SERVICE_ACCOUNT_KEY }}
    - name: Pull Latest Image
      with:
        name: replicated-test/rasa-demo:latest
        username: ${{ steps.gcloud.outputs.username }}
        password: ${{ steps.gcloud.outputs.password }}
        run: |
          docker pull gcr.io/replicated-test/rasa-demo:latest || true